(function(){"use strict";var xe={};function T(e,t,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function a(l){try{u(r.next(l))}catch(f){o(f)}}function c(l){try{u(r.throw(l))}catch(f){o(f)}}function u(l){l.done?s(l.value):i(l.value).then(a,c)}u((r=r.apply(e,t||[])).next())})}typeof SuppressedError=="function"&&SuppressedError;var nn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Re={exports:{}};(function(e){(function(t,n){e.exports?e.exports=n():t.log=n()})(nn,function(){var t=function(){},n="undefined",r=typeof window!==n&&typeof window.navigator!==n&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"],s={},o=null;function a(y,v){var p=y[v];if(typeof p.bind=="function")return p.bind(y);try{return Function.prototype.bind.call(p,y)}catch{return function(){return Function.prototype.apply.apply(p,[y,arguments])}}}function c(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function u(y){return y==="debug"&&(y="log"),typeof console===n?!1:y==="trace"&&r?c:console[y]!==void 0?a(console,y):console.log!==void 0?a(console,"log"):t}function l(){for(var y=this.getLevel(),v=0;v<i.length;v++){var p=i[v];this[p]=v<y?t:this.methodFactory(p,y,this.name)}if(this.log=this.debug,typeof console===n&&y<this.levels.SILENT)return"No console available for logging"}function f(y){return function(){typeof console!==n&&(l.call(this),this[y].apply(this,arguments))}}function h(y,v,p){return u(y)||f.apply(this,arguments)}function b(y,v){var p=this,V,q,M,E="loglevel";typeof y=="string"?E+=":"+y:typeof y=="symbol"&&(E=void 0);function _r(k){var C=(i[k]||"silent").toUpperCase();if(!(typeof window===n||!E)){try{window.localStorage[E]=C;return}catch{}try{window.document.cookie=encodeURIComponent(E)+"="+C+";"}catch{}}}function Zt(){var k;if(!(typeof window===n||!E)){try{k=window.localStorage[E]}catch{}if(typeof k===n)try{var C=window.document.cookie,ve=encodeURIComponent(E),tn=C.indexOf(ve+"=");tn!==-1&&(k=/^([^;]+)/.exec(C.slice(tn+ve.length+1))[1])}catch{}return p.levels[k]===void 0&&(k=void 0),k}}function Ur(){if(!(typeof window===n||!E)){try{window.localStorage.removeItem(E)}catch{}try{window.document.cookie=encodeURIComponent(E)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function re(k){var C=k;if(typeof C=="string"&&p.levels[C.toUpperCase()]!==void 0&&(C=p.levels[C.toUpperCase()]),typeof C=="number"&&C>=0&&C<=p.levels.SILENT)return C;throw new TypeError("log.setLevel() called with invalid level: "+k)}p.name=y,p.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},p.methodFactory=v||h,p.getLevel=function(){return M??q??V},p.setLevel=function(k,C){return M=re(k),C!==!1&&_r(M),l.call(p)},p.setDefaultLevel=function(k){q=re(k),Zt()||p.setLevel(k,!1)},p.resetLevel=function(){M=null,Ur(),l.call(p)},p.enableAll=function(k){p.setLevel(p.levels.TRACE,k)},p.disableAll=function(k){p.setLevel(p.levels.SILENT,k)},p.rebuild=function(){if(o!==p&&(V=re(o.getLevel())),l.call(p),o===p)for(var k in s)s[k].rebuild()},V=re(o?o.getLevel():"WARN");var en=Zt();en!=null&&(M=re(en)),l.call(p)}o=new b,o.getLogger=function(v){if(typeof v!="symbol"&&typeof v!="string"||v==="")throw new TypeError("You must supply a name when creating a logger.");var p=s[v];return p||(p=s[v]=new b(v,o.methodFactory)),p};var N=typeof window!==n?window.log:void 0;return o.noConflict=function(){return typeof window!==n&&window.log===o&&(window.log=N),o},o.getLoggers=function(){return s},o.default=o,o})})(Re);var ie=Re.exports,Te;(function(e){e[e.trace=0]="trace",e[e.debug=1]="debug",e[e.info=2]="info",e[e.warn=3]="warn",e[e.error=4]="error",e[e.silent=5]="silent"})(Te||(Te={}));var se;(function(e){e.Default="livekit",e.Room="livekit-room",e.Participant="livekit-participant",e.Track="livekit-track",e.Publication="livekit-track-publication",e.Engine="livekit-engine",e.Signal="livekit-signal",e.PCManager="livekit-pc-manager",e.PCTransport="livekit-pc-transport",e.E2EE="lk-e2ee"})(se||(se={}));let H=ie.getLogger("livekit");Object.values(se).map(e=>ie.getLogger(e)),H.setDefaultLevel(Te.info);function Ke(e){const t=ie.getLogger(e);return t.setDefaultLevel(H.getLevel()),t}const g=ie.getLogger("lk-e2ee");function S(e,t){if(!e)throw new Error(t)}const rn=34028234663852886e22,sn=-34028234663852886e22,on=4294967295,an=2147483647,cn=-2147483648;function oe(e){if(typeof e!="number")throw new Error("invalid int 32: "+typeof e);if(!Number.isInteger(e)||e>an||e<cn)throw new Error("invalid int 32: "+e)}function Ne(e){if(typeof e!="number")throw new Error("invalid uint 32: "+typeof e);if(!Number.isInteger(e)||e>on||e<0)throw new Error("invalid uint 32: "+e)}function Ve(e){if(typeof e!="number")throw new Error("invalid float 32: "+typeof e);if(Number.isFinite(e)&&(e>rn||e<sn))throw new Error("invalid float 32: "+e)}const Ge=Symbol("@bufbuild/protobuf/enum-type");function un(e){const t=e[Ge];return S(t,"missing enum type on enum object"),t}function je(e,t,n,r){e[Ge]=Xe(t,n.map(i=>({no:i.no,name:i.name,localName:e[i.no]})))}function Xe(e,t,n){const r=Object.create(null),i=Object.create(null),s=[];for(const o of t){const a=Je(o);s.push(a),r[o.name]=a,i[o.no]=a}return{typeName:e,values:s,findName(o){return r[o]},findNumber(o){return i[o]}}}function dn(e,t,n){const r={};for(const i of t){const s=Je(i);r[s.localName]=s.no,r[s.no]=s.localName}return je(r,e,t),r}function Je(e){return"localName"in e?e:Object.assign(Object.assign({},e),{localName:e.name})}class qe{equals(t){return this.getType().runtime.util.equals(this.getType(),this,t)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(t,n){const r=this.getType(),i=r.runtime.bin,s=i.makeReadOptions(n);return i.readMessage(this,s.readerFactory(t),t.byteLength,s),this}fromJson(t,n){const r=this.getType(),i=r.runtime.json,s=i.makeReadOptions(n);return i.readMessage(r,t,s,this),this}fromJsonString(t,n){let r;try{r=JSON.parse(t)}catch(i){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(i instanceof Error?i.message:String(i)))}return this.fromJson(r,n)}toBinary(t){const n=this.getType(),r=n.runtime.bin,i=r.makeWriteOptions(t),s=i.writerFactory();return r.writeMessage(this,s,i),s.finish()}toJson(t){const n=this.getType(),r=n.runtime.json,i=r.makeWriteOptions(t);return r.writeMessage(this,i)}toJsonString(t){var n;const r=this.toJson(t);return JSON.stringify(r,null,(n=t==null?void 0:t.prettySpaces)!==null&&n!==void 0?n:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function ln(e,t,n,r){var i;const s=(i=r==null?void 0:r.localName)!==null&&i!==void 0?i:t.substring(t.lastIndexOf(".")+1),o={[s]:function(a){e.util.initFields(this),e.util.initPartial(a,this)}}[s];return Object.setPrototypeOf(o.prototype,new qe),Object.assign(o,{runtime:e,typeName:t,fields:e.util.newFieldList(n),fromBinary(a,c){return new o().fromBinary(a,c)},fromJson(a,c){return new o().fromJson(a,c)},fromJsonString(a,c){return new o().fromJsonString(a,c)},equals(a,c){return e.util.equals(o,a,c)}}),o}function fn(){let e=0,t=0;for(let r=0;r<28;r+=7){let i=this.buf[this.pos++];if(e|=(i&127)<<r,!(i&128))return this.assertBounds(),[e,t]}let n=this.buf[this.pos++];if(e|=(n&15)<<28,t=(n&112)>>4,!(n&128))return this.assertBounds(),[e,t];for(let r=3;r<=31;r+=7){let i=this.buf[this.pos++];if(t|=(i&127)<<r,!(i&128))return this.assertBounds(),[e,t]}throw new Error("invalid varint")}function Ce(e,t,n){for(let s=0;s<28;s=s+7){const o=e>>>s,a=!(!(o>>>7)&&t==0),c=(a?o|128:o)&255;if(n.push(c),!a)return}const r=e>>>28&15|(t&7)<<4,i=!!(t>>3);if(n.push((i?r|128:r)&255),!!i){for(let s=3;s<31;s=s+7){const o=t>>>s,a=!!(o>>>7),c=(a?o|128:o)&255;if(n.push(c),!a)return}n.push(t>>>31&1)}}const ae=4294967296;function He(e){const t=e[0]==="-";t&&(e=e.slice(1));const n=1e6;let r=0,i=0;function s(o,a){const c=Number(e.slice(o,a));i*=n,r=r*n+c,r>=ae&&(i=i+(r/ae|0),r=r%ae)}return s(-24,-18),s(-18,-12),s(-12,-6),s(-6),t?Ye(r,i):Ee(r,i)}function hn(e,t){let n=Ee(e,t);const r=n.hi&2147483648;r&&(n=Ye(n.lo,n.hi));const i=We(n.lo,n.hi);return r?"-"+i:i}function We(e,t){if({lo:e,hi:t}=pn(e,t),t<=2097151)return String(ae*t+e);const n=e&16777215,r=(e>>>24|t<<8)&16777215,i=t>>16&65535;let s=n+r*6777216+i*6710656,o=r+i*8147497,a=i*2;const c=1e7;return s>=c&&(o+=Math.floor(s/c),s%=c),o>=c&&(a+=Math.floor(o/c),o%=c),a.toString()+ze(o)+ze(s)}function pn(e,t){return{lo:e>>>0,hi:t>>>0}}function Ee(e,t){return{lo:e|0,hi:t|0}}function Ye(e,t){return t=~t,e?e=~e+1:t+=1,Ee(e,t)}const ze=e=>{const t=String(e);return"0000000".slice(t.length)+t};function $e(e,t){if(e>=0){for(;e>127;)t.push(e&127|128),e=e>>>7;t.push(e)}else{for(let n=0;n<9;n++)t.push(e&127|128),e=e>>7;t.push(1)}}function gn(){let e=this.buf[this.pos++],t=e&127;if(!(e&128))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(e&127)<<7,!(e&128))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(e&127)<<14,!(e&128))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(e&127)<<21,!(e&128))return this.assertBounds(),t;e=this.buf[this.pos++],t|=(e&15)<<28;for(let n=5;e&128&&n<10;n++)e=this.buf[this.pos++];if(e&128)throw new Error("invalid varint");return this.assertBounds(),t>>>0}function yn(){const e=new DataView(new ArrayBuffer(8));if(typeof BigInt=="function"&&typeof e.getBigInt64=="function"&&typeof e.getBigUint64=="function"&&typeof e.setBigInt64=="function"&&typeof e.setBigUint64=="function"&&(typeof process!="object"||typeof xe!="object"||xe.BUF_BIGINT_DISABLE!=="1")){const i=BigInt("-9223372036854775808"),s=BigInt("9223372036854775807"),o=BigInt("0"),a=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(c){const u=typeof c=="bigint"?c:BigInt(c);if(u>s||u<i)throw new Error("int64 invalid: ".concat(c));return u},uParse(c){const u=typeof c=="bigint"?c:BigInt(c);if(u>a||u<o)throw new Error("uint64 invalid: ".concat(c));return u},enc(c){return e.setBigInt64(0,this.parse(c),!0),{lo:e.getInt32(0,!0),hi:e.getInt32(4,!0)}},uEnc(c){return e.setBigInt64(0,this.uParse(c),!0),{lo:e.getInt32(0,!0),hi:e.getInt32(4,!0)}},dec(c,u){return e.setInt32(0,c,!0),e.setInt32(4,u,!0),e.getBigInt64(0,!0)},uDec(c,u){return e.setInt32(0,c,!0),e.setInt32(4,u,!0),e.getBigUint64(0,!0)}}}const n=i=>S(/^-?[0-9]+$/.test(i),"int64 invalid: ".concat(i)),r=i=>S(/^[0-9]+$/.test(i),"uint64 invalid: ".concat(i));return{zero:"0",supported:!1,parse(i){return typeof i!="string"&&(i=i.toString()),n(i),i},uParse(i){return typeof i!="string"&&(i=i.toString()),r(i),i},enc(i){return typeof i!="string"&&(i=i.toString()),n(i),He(i)},uEnc(i){return typeof i!="string"&&(i=i.toString()),r(i),He(i)},dec(i,s){return hn(i,s)},uDec(i,s){return We(i,s)}}}const O=yn();var d;(function(e){e[e.DOUBLE=1]="DOUBLE",e[e.FLOAT=2]="FLOAT",e[e.INT64=3]="INT64",e[e.UINT64=4]="UINT64",e[e.INT32=5]="INT32",e[e.FIXED64=6]="FIXED64",e[e.FIXED32=7]="FIXED32",e[e.BOOL=8]="BOOL",e[e.STRING=9]="STRING",e[e.BYTES=12]="BYTES",e[e.UINT32=13]="UINT32",e[e.SFIXED32=15]="SFIXED32",e[e.SFIXED64=16]="SFIXED64",e[e.SINT32=17]="SINT32",e[e.SINT64=18]="SINT64"})(d||(d={}));var P;(function(e){e[e.BIGINT=0]="BIGINT",e[e.STRING=1]="STRING"})(P||(P={}));function B(e,t,n){if(t===n)return!0;if(e==d.BYTES){if(!(t instanceof Uint8Array)||!(n instanceof Uint8Array)||t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==n[r])return!1;return!0}switch(e){case d.UINT64:case d.FIXED64:case d.INT64:case d.SFIXED64:case d.SINT64:return t==n}return!1}function G(e,t){switch(e){case d.BOOL:return!1;case d.UINT64:case d.FIXED64:case d.INT64:case d.SFIXED64:case d.SINT64:return t==0?O.zero:"0";case d.DOUBLE:case d.FLOAT:return 0;case d.BYTES:return new Uint8Array(0);case d.STRING:return"";default:return 0}}function Qe(e,t){switch(e){case d.BOOL:return t===!1;case d.STRING:return t==="";case d.BYTES:return t instanceof Uint8Array&&!t.byteLength;default:return t==0}}var I;(function(e){e[e.Varint=0]="Varint",e[e.Bit64=1]="Bit64",e[e.LengthDelimited=2]="LengthDelimited",e[e.StartGroup=3]="StartGroup",e[e.EndGroup=4]="EndGroup",e[e.Bit32=5]="Bit32"})(I||(I={}));class mn{constructor(t){this.stack=[],this.textEncoder=t??new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let t=0;for(let i=0;i<this.chunks.length;i++)t+=this.chunks[i].length;let n=new Uint8Array(t),r=0;for(let i=0;i<this.chunks.length;i++)n.set(this.chunks[i],r),r+=this.chunks[i].length;return this.chunks=[],n}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let t=this.finish(),n=this.stack.pop();if(!n)throw new Error("invalid state, fork stack empty");return this.chunks=n.chunks,this.buf=n.buf,this.uint32(t.byteLength),this.raw(t)}tag(t,n){return this.uint32((t<<3|n)>>>0)}raw(t){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(t),this}uint32(t){for(Ne(t);t>127;)this.buf.push(t&127|128),t=t>>>7;return this.buf.push(t),this}int32(t){return oe(t),$e(t,this.buf),this}bool(t){return this.buf.push(t?1:0),this}bytes(t){return this.uint32(t.byteLength),this.raw(t)}string(t){let n=this.textEncoder.encode(t);return this.uint32(n.byteLength),this.raw(n)}float(t){Ve(t);let n=new Uint8Array(4);return new DataView(n.buffer).setFloat32(0,t,!0),this.raw(n)}double(t){let n=new Uint8Array(8);return new DataView(n.buffer).setFloat64(0,t,!0),this.raw(n)}fixed32(t){Ne(t);let n=new Uint8Array(4);return new DataView(n.buffer).setUint32(0,t,!0),this.raw(n)}sfixed32(t){oe(t);let n=new Uint8Array(4);return new DataView(n.buffer).setInt32(0,t,!0),this.raw(n)}sint32(t){return oe(t),t=(t<<1^t>>31)>>>0,$e(t,this.buf),this}sfixed64(t){let n=new Uint8Array(8),r=new DataView(n.buffer),i=O.enc(t);return r.setInt32(0,i.lo,!0),r.setInt32(4,i.hi,!0),this.raw(n)}fixed64(t){let n=new Uint8Array(8),r=new DataView(n.buffer),i=O.uEnc(t);return r.setInt32(0,i.lo,!0),r.setInt32(4,i.hi,!0),this.raw(n)}int64(t){let n=O.enc(t);return Ce(n.lo,n.hi,this.buf),this}sint64(t){let n=O.enc(t),r=n.hi>>31,i=n.lo<<1^r,s=(n.hi<<1|n.lo>>>31)^r;return Ce(i,s,this.buf),this}uint64(t){let n=O.uEnc(t);return Ce(n.lo,n.hi,this.buf),this}}class bn{constructor(t,n){this.varint64=fn,this.uint32=gn,this.buf=t,this.len=t.length,this.pos=0,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.textDecoder=n??new TextDecoder}tag(){let t=this.uint32(),n=t>>>3,r=t&7;if(n<=0||r<0||r>5)throw new Error("illegal tag: field no "+n+" wire type "+r);return[n,r]}skip(t,n){let r=this.pos;switch(t){case I.Varint:for(;this.buf[this.pos++]&128;);break;case I.Bit64:this.pos+=4;case I.Bit32:this.pos+=4;break;case I.LengthDelimited:let i=this.uint32();this.pos+=i;break;case I.StartGroup:for(;;){const[s,o]=this.tag();if(o===I.EndGroup){if(n!==void 0&&s!==n)throw new Error("invalid end group tag");break}this.skip(o,s)}break;default:throw new Error("cant skip wire type "+t)}return this.assertBounds(),this.buf.subarray(r,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let t=this.uint32();return t>>>1^-(t&1)}int64(){return O.dec(...this.varint64())}uint64(){return O.uDec(...this.varint64())}sint64(){let[t,n]=this.varint64(),r=-(t&1);return t=(t>>>1|(n&1)<<31)^r,n=n>>>1^r,O.dec(t,n)}bool(){let[t,n]=this.varint64();return t!==0||n!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return O.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return O.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let t=this.uint32(),n=this.pos;return this.pos+=t,this.assertBounds(),this.buf.subarray(n,n+t)}string(){return this.textDecoder.decode(this.bytes())}}function wn(e,t,n,r){let i;return{typeName:t,extendee:n,get field(){if(!i){const s=typeof r=="function"?r():r;s.name=t.split(".").pop(),s.jsonName="[".concat(t,"]"),i=e.util.newFieldList([s]).list()[0]}return i},runtime:e}}function Ze(e){const t=e.field.localName,n=Object.create(null);return n[t]=kn(e),[n,()=>n[t]]}function kn(e){const t=e.field;if(t.repeated)return[];if(t.default!==void 0)return t.default;switch(t.kind){case"enum":return t.T.values[0].no;case"scalar":return G(t.T,t.L);case"message":const n=t.T,r=new n;return n.fieldWrapper?n.fieldWrapper.unwrapField(r):r;case"map":throw"map fields are not allowed to be extensions"}}function Sn(e,t){if(!t.repeated&&(t.kind=="enum"||t.kind=="scalar")){for(let n=e.length-1;n>=0;--n)if(e[n].no==t.no)return[e[n]];return[]}return e.filter(n=>n.no===t.no)}let F="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),ce=[];for(let e=0;e<F.length;e++)ce[F[e].charCodeAt(0)]=e;ce[45]=F.indexOf("+"),ce[95]=F.indexOf("/");const et={dec(e){let t=e.length*3/4;e[e.length-2]=="="?t-=2:e[e.length-1]=="="&&(t-=1);let n=new Uint8Array(t),r=0,i=0,s,o=0;for(let a=0;a<e.length;a++){if(s=ce[e.charCodeAt(a)],s===void 0)switch(e[a]){case"=":i=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(i){case 0:o=s,i=1;break;case 1:n[r++]=o<<2|(s&48)>>4,o=s,i=2;break;case 2:n[r++]=(o&15)<<4|(s&60)>>2,o=s,i=3;break;case 3:n[r++]=(o&3)<<6|s,i=0;break}}if(i==1)throw Error("invalid base64 string.");return n.subarray(0,r)},enc(e){let t="",n=0,r,i=0;for(let s=0;s<e.length;s++)switch(r=e[s],n){case 0:t+=F[r>>2],i=(r&3)<<4,n=1;break;case 1:t+=F[i|r>>4],i=(r&15)<<2,n=2;break;case 2:t+=F[i|r>>6],t+=F[r&63],n=0;break}return n&&(t+=F[i],t+="=",n==1&&(t+="=")),t}};function In(e,t,n){nt(t,e);const r=t.runtime.bin.makeReadOptions(n),i=Sn(e.getType().runtime.bin.listUnknownFields(e),t.field),[s,o]=Ze(t);for(const a of i)t.runtime.bin.readField(s,r.readerFactory(a.data),t.field,a.wireType,r);return o()}function vn(e,t,n,r){nt(t,e);const i=t.runtime.bin.makeReadOptions(r),s=t.runtime.bin.makeWriteOptions(r);if(tt(e,t)){const u=e.getType().runtime.bin.listUnknownFields(e).filter(l=>l.no!=t.field.no);e.getType().runtime.bin.discardUnknownFields(e);for(const l of u)e.getType().runtime.bin.onUnknownField(e,l.no,l.wireType,l.data)}const o=s.writerFactory();let a=t.field;!a.opt&&!a.repeated&&(a.kind=="enum"||a.kind=="scalar")&&(a=Object.assign(Object.assign({},t.field),{opt:!0})),t.runtime.bin.writeField(a,n,o,s);const c=i.readerFactory(o.finish());for(;c.pos<c.len;){const[u,l]=c.tag(),f=c.skip(l,u);e.getType().runtime.bin.onUnknownField(e,u,l,f)}}function tt(e,t){const n=e.getType();return t.extendee.typeName===n.typeName&&!!n.runtime.bin.listUnknownFields(e).find(r=>r.no==t.field.no)}function nt(e,t){S(e.extendee.typeName==t.getType().typeName,"extension ".concat(e.typeName," can only be applied to message ").concat(e.extendee.typeName))}function rt(e,t){const n=e.localName;if(e.repeated)return t[n].length>0;if(e.oneof)return t[e.oneof.localName].case===n;switch(e.kind){case"enum":case"scalar":return e.opt||e.req?t[n]!==void 0:e.kind=="enum"?t[n]!==e.T.values[0].no:!Qe(e.T,t[n]);case"message":return t[n]!==void 0;case"map":return Object.keys(t[n]).length>0}}function it(e,t){const n=e.localName,r=!e.opt&&!e.req;if(e.repeated)t[n]=[];else if(e.oneof)t[e.oneof.localName]={case:void 0};else switch(e.kind){case"map":t[n]={};break;case"enum":t[n]=r?e.T.values[0].no:void 0;break;case"scalar":t[n]=r?G(e.T,e.L):void 0;break;case"message":t[n]=void 0;break}}function K(e,t){if(e===null||typeof e!="object"||!Object.getOwnPropertyNames(qe.prototype).every(r=>r in e&&typeof e[r]=="function"))return!1;const n=e.getType();return n===null||typeof n!="function"||!("typeName"in n)||typeof n.typeName!="string"?!1:t===void 0?!0:n.typeName==t.typeName}function st(e,t){return K(t)||!e.fieldWrapper?t:e.fieldWrapper.wrapField(t)}d.DOUBLE,d.FLOAT,d.INT64,d.UINT64,d.INT32,d.UINT32,d.BOOL,d.STRING,d.BYTES;const ot={ignoreUnknownFields:!1},at={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function Tn(e){return e?Object.assign(Object.assign({},ot),e):ot}function Nn(e){return e?Object.assign(Object.assign({},at),e):at}const ue=Symbol(),de=Symbol();function Cn(){return{makeReadOptions:Tn,makeWriteOptions:Nn,readMessage(e,t,n,r){if(t==null||Array.isArray(t)||typeof t!="object")throw new Error("cannot decode message ".concat(e.typeName," from JSON: ").concat(A(t)));r=r??new e;const i=new Map,s=n.typeRegistry;for(const[o,a]of Object.entries(t)){const c=e.fields.findJsonName(o);if(c){if(c.oneof){if(a===null&&c.kind=="scalar")continue;const u=i.get(c.oneof);if(u!==void 0)throw new Error("cannot decode message ".concat(e.typeName,' from JSON: multiple keys for oneof "').concat(c.oneof.name,'" present: "').concat(u,'", "').concat(o,'"'));i.set(c.oneof,o)}ct(r,a,c,n,e)}else{let u=!1;if(s!=null&&s.findExtension&&o.startsWith("[")&&o.endsWith("]")){const l=s.findExtension(o.substring(1,o.length-1));if(l&&l.extendee.typeName==e.typeName){u=!0;const[f,h]=Ze(l);ct(f,a,l.field,n,l),vn(r,l,h(),n)}}if(!u&&!n.ignoreUnknownFields)throw new Error("cannot decode message ".concat(e.typeName,' from JSON: key "').concat(o,'" is unknown'))}}return r},writeMessage(e,t){const n=e.getType(),r={};let i;try{for(i of n.fields.byNumber()){if(!rt(i,e)){if(i.req)throw"required field not set";if(!t.emitDefaultValues||!On(i))continue}const o=i.oneof?e[i.oneof.localName].value:e[i.localName],a=ut(i,o,t);a!==void 0&&(r[t.useProtoFieldName?i.name:i.jsonName]=a)}const s=t.typeRegistry;if(s!=null&&s.findExtensionFor)for(const o of n.runtime.bin.listUnknownFields(e)){const a=s.findExtensionFor(n.typeName,o.no);if(a&&tt(e,a)){const c=In(e,a,t),u=ut(a.field,c,t);u!==void 0&&(r[a.field.jsonName]=u)}}}catch(s){const o=i?"cannot encode field ".concat(n.typeName,".").concat(i.name," to JSON"):"cannot encode message ".concat(n.typeName," to JSON"),a=s instanceof Error?s.message:String(s);throw new Error(o+(a.length>0?": ".concat(a):""))}return r},readScalar(e,t,n){return W(e,t,n??P.BIGINT,!0)},writeScalar(e,t,n){if(t!==void 0&&(n||Qe(e,t)))return le(e,t)},debug:A}}function A(e){if(e===null)return"null";switch(typeof e){case"object":return Array.isArray(e)?"array":"object";case"string":return e.length>100?"string":'"'.concat(e.split('"').join('\\"'),'"');default:return String(e)}}function ct(e,t,n,r,i){let s=n.localName;if(n.repeated){if(S(n.kind!="map"),t===null)return;if(!Array.isArray(t))throw new Error("cannot decode field ".concat(i.typeName,".").concat(n.name," from JSON: ").concat(A(t)));const o=e[s];for(const a of t){if(a===null)throw new Error("cannot decode field ".concat(i.typeName,".").concat(n.name," from JSON: ").concat(A(a)));switch(n.kind){case"message":o.push(n.T.fromJson(a,r));break;case"enum":const c=Oe(n.T,a,r.ignoreUnknownFields,!0);c!==de&&o.push(c);break;case"scalar":try{o.push(W(n.T,a,n.L,!0))}catch(u){let l="cannot decode field ".concat(i.typeName,".").concat(n.name," from JSON: ").concat(A(a));throw u instanceof Error&&u.message.length>0&&(l+=": ".concat(u.message)),new Error(l)}break}}}else if(n.kind=="map"){if(t===null)return;if(typeof t!="object"||Array.isArray(t))throw new Error("cannot decode field ".concat(i.typeName,".").concat(n.name," from JSON: ").concat(A(t)));const o=e[s];for(const[a,c]of Object.entries(t)){if(c===null)throw new Error("cannot decode field ".concat(i.typeName,".").concat(n.name," from JSON: map value null"));let u;try{u=En(n.K,a)}catch(l){let f="cannot decode map key for field ".concat(i.typeName,".").concat(n.name," from JSON: ").concat(A(t));throw l instanceof Error&&l.message.length>0&&(f+=": ".concat(l.message)),new Error(f)}switch(n.V.kind){case"message":o[u]=n.V.T.fromJson(c,r);break;case"enum":const l=Oe(n.V.T,c,r.ignoreUnknownFields,!0);l!==de&&(o[u]=l);break;case"scalar":try{o[u]=W(n.V.T,c,P.BIGINT,!0)}catch(f){let h="cannot decode map value for field ".concat(i.typeName,".").concat(n.name," from JSON: ").concat(A(t));throw f instanceof Error&&f.message.length>0&&(h+=": ".concat(f.message)),new Error(h)}break}}}else switch(n.oneof&&(e=e[n.oneof.localName]={case:s},s="value"),n.kind){case"message":const o=n.T;if(t===null&&o.typeName!="google.protobuf.Value")return;let a=e[s];K(a)?a.fromJson(t,r):(e[s]=a=o.fromJson(t,r),o.fieldWrapper&&!n.oneof&&(e[s]=o.fieldWrapper.unwrapField(a)));break;case"enum":const c=Oe(n.T,t,r.ignoreUnknownFields,!1);switch(c){case ue:it(n,e);break;case de:break;default:e[s]=c;break}break;case"scalar":try{const u=W(n.T,t,n.L,!1);switch(u){case ue:it(n,e);break;default:e[s]=u;break}}catch(u){let l="cannot decode field ".concat(i.typeName,".").concat(n.name," from JSON: ").concat(A(t));throw u instanceof Error&&u.message.length>0&&(l+=": ".concat(u.message)),new Error(l)}break}}function En(e,t){if(e===d.BOOL)switch(t){case"true":t=!0;break;case"false":t=!1;break}return W(e,t,P.BIGINT,!0).toString()}function W(e,t,n,r){if(t===null)return r?G(e,n):ue;switch(e){case d.DOUBLE:case d.FLOAT:if(t==="NaN")return Number.NaN;if(t==="Infinity")return Number.POSITIVE_INFINITY;if(t==="-Infinity")return Number.NEGATIVE_INFINITY;if(t===""||typeof t=="string"&&t.trim().length!==t.length||typeof t!="string"&&typeof t!="number")break;const i=Number(t);if(Number.isNaN(i)||!Number.isFinite(i))break;return e==d.FLOAT&&Ve(i),i;case d.INT32:case d.FIXED32:case d.SFIXED32:case d.SINT32:case d.UINT32:let s;if(typeof t=="number"?s=t:typeof t=="string"&&t.length>0&&t.trim().length===t.length&&(s=Number(t)),s===void 0)break;return e==d.UINT32||e==d.FIXED32?Ne(s):oe(s),s;case d.INT64:case d.SFIXED64:case d.SINT64:if(typeof t!="number"&&typeof t!="string")break;const o=O.parse(t);return n?o.toString():o;case d.FIXED64:case d.UINT64:if(typeof t!="number"&&typeof t!="string")break;const a=O.uParse(t);return n?a.toString():a;case d.BOOL:if(typeof t!="boolean")break;return t;case d.STRING:if(typeof t!="string")break;try{encodeURIComponent(t)}catch{throw new Error("invalid UTF8")}return t;case d.BYTES:if(t==="")return new Uint8Array(0);if(typeof t!="string")break;return et.dec(t)}throw new Error}function Oe(e,t,n,r){if(t===null)return e.typeName=="google.protobuf.NullValue"?0:r?e.values[0].no:ue;switch(typeof t){case"number":if(Number.isInteger(t))return t;break;case"string":const i=e.findName(t);if(i!==void 0)return i.no;if(n)return de;break}throw new Error("cannot decode enum ".concat(e.typeName," from JSON: ").concat(A(t)))}function On(e){return e.repeated||e.kind=="map"?!0:!(e.oneof||e.kind=="message"||e.opt||e.req)}function ut(e,t,n){if(e.kind=="map"){S(typeof t=="object"&&t!=null);const r={},i=Object.entries(t);switch(e.V.kind){case"scalar":for(const[o,a]of i)r[o.toString()]=le(e.V.T,a);break;case"message":for(const[o,a]of i)r[o.toString()]=a.toJson(n);break;case"enum":const s=e.V.T;for(const[o,a]of i)r[o.toString()]=Ae(s,a,n.enumAsInteger);break}return n.emitDefaultValues||i.length>0?r:void 0}if(e.repeated){S(Array.isArray(t));const r=[];switch(e.kind){case"scalar":for(let i=0;i<t.length;i++)r.push(le(e.T,t[i]));break;case"enum":for(let i=0;i<t.length;i++)r.push(Ae(e.T,t[i],n.enumAsInteger));break;case"message":for(let i=0;i<t.length;i++)r.push(t[i].toJson(n));break}return n.emitDefaultValues||r.length>0?r:void 0}switch(e.kind){case"scalar":return le(e.T,t);case"enum":return Ae(e.T,t,n.enumAsInteger);case"message":return st(e.T,t).toJson(n)}}function Ae(e,t,n){var r;if(S(typeof t=="number"),e.typeName=="google.protobuf.NullValue")return null;if(n)return t;const i=e.findNumber(t);return(r=i==null?void 0:i.name)!==null&&r!==void 0?r:t}function le(e,t){switch(e){case d.INT32:case d.SFIXED32:case d.SINT32:case d.FIXED32:case d.UINT32:return S(typeof t=="number"),t;case d.FLOAT:case d.DOUBLE:return S(typeof t=="number"),Number.isNaN(t)?"NaN":t===Number.POSITIVE_INFINITY?"Infinity":t===Number.NEGATIVE_INFINITY?"-Infinity":t;case d.STRING:return S(typeof t=="string"),t;case d.BOOL:return S(typeof t=="boolean"),t;case d.UINT64:case d.FIXED64:case d.INT64:case d.SFIXED64:case d.SINT64:return S(typeof t=="bigint"||typeof t=="string"||typeof t=="number"),t.toString();case d.BYTES:return S(t instanceof Uint8Array),et.enc(t)}}const j=Symbol("@bufbuild/protobuf/unknown-fields"),dt={readUnknownFields:!0,readerFactory:e=>new bn(e)},lt={writeUnknownFields:!0,writerFactory:()=>new mn};function An(e){return e?Object.assign(Object.assign({},dt),e):dt}function Ln(e){return e?Object.assign(Object.assign({},lt),e):lt}function Fn(){return{makeReadOptions:An,makeWriteOptions:Ln,listUnknownFields(e){var t;return(t=e[j])!==null&&t!==void 0?t:[]},discardUnknownFields(e){delete e[j]},writeUnknownFields(e,t){const r=e[j];if(r)for(const i of r)t.tag(i.no,i.wireType).raw(i.data)},onUnknownField(e,t,n,r){const i=e;Array.isArray(i[j])||(i[j]=[]),i[j].push({no:t,wireType:n,data:r})},readMessage(e,t,n,r,i){const s=e.getType(),o=i?t.len:t.pos+n;let a,c;for(;t.pos<o&&([a,c]=t.tag(),!(i===!0&&c==I.EndGroup));){const u=s.fields.find(a);if(!u){const l=t.skip(c,a);r.readUnknownFields&&this.onUnknownField(e,a,c,l);continue}ft(e,t,u,c,r)}if(i&&(c!=I.EndGroup||a!==n))throw new Error("invalid end group tag")},readField:ft,writeMessage(e,t,n){const r=e.getType();for(const i of r.fields.byNumber()){if(!rt(i,e)){if(i.req)throw new Error("cannot encode field ".concat(r.typeName,".").concat(i.name," to binary: required field not set"));continue}const s=i.oneof?e[i.oneof.localName].value:e[i.localName];ht(i,s,t,n)}return n.writeUnknownFields&&this.writeUnknownFields(e,t),t},writeField(e,t,n,r){t!==void 0&&ht(e,t,n,r)}}}function ft(e,t,n,r,i){let{repeated:s,localName:o}=n;switch(n.oneof&&(e=e[n.oneof.localName],e.case!=o&&delete e.value,e.case=o,o="value"),n.kind){case"scalar":case"enum":const a=n.kind=="enum"?d.INT32:n.T;let c=he;if(n.kind=="scalar"&&n.L>0&&(c=Un),s){let h=e[o];if(r==I.LengthDelimited&&a!=d.STRING&&a!=d.BYTES){let N=t.uint32()+t.pos;for(;t.pos<N;)h.push(c(t,a))}else h.push(c(t,a))}else e[o]=c(t,a);break;case"message":const u=n.T;s?e[o].push(fe(t,new u,i,n)):K(e[o])?fe(t,e[o],i,n):(e[o]=fe(t,new u,i,n),u.fieldWrapper&&!n.oneof&&!n.repeated&&(e[o]=u.fieldWrapper.unwrapField(e[o])));break;case"map":let[l,f]=_n(n,t,i);e[o][l]=f;break}}function fe(e,t,n,r){const i=t.getType().runtime.bin,s=r==null?void 0:r.delimited;return i.readMessage(t,e,s?r.no:e.uint32(),n,s),t}function _n(e,t,n){const r=t.uint32(),i=t.pos+r;let s,o;for(;t.pos<i;){const[a]=t.tag();switch(a){case 1:s=he(t,e.K);break;case 2:switch(e.V.kind){case"scalar":o=he(t,e.V.T);break;case"enum":o=t.int32();break;case"message":o=fe(t,new e.V.T,n,void 0);break}break}}if(s===void 0&&(s=G(e.K,P.BIGINT)),typeof s!="string"&&typeof s!="number"&&(s=s.toString()),o===void 0)switch(e.V.kind){case"scalar":o=G(e.V.T,P.BIGINT);break;case"enum":o=e.V.T.values[0].no;break;case"message":o=new e.V.T;break}return[s,o]}function Un(e,t){const n=he(e,t);return typeof n=="bigint"?n.toString():n}function he(e,t){switch(t){case d.STRING:return e.string();case d.BOOL:return e.bool();case d.DOUBLE:return e.double();case d.FLOAT:return e.float();case d.INT32:return e.int32();case d.INT64:return e.int64();case d.UINT64:return e.uint64();case d.FIXED64:return e.fixed64();case d.BYTES:return e.bytes();case d.FIXED32:return e.fixed32();case d.SFIXED32:return e.sfixed32();case d.SFIXED64:return e.sfixed64();case d.SINT64:return e.sint64();case d.UINT32:return e.uint32();case d.SINT32:return e.sint32()}}function ht(e,t,n,r){S(t!==void 0);const i=e.repeated;switch(e.kind){case"scalar":case"enum":let s=e.kind=="enum"?d.INT32:e.T;if(i)if(S(Array.isArray(t)),e.packed)Mn(n,s,e.no,t);else for(const o of t)Y(n,s,e.no,o);else Y(n,s,e.no,t);break;case"message":if(i){S(Array.isArray(t));for(const o of t)pt(n,r,e,o)}else pt(n,r,e,t);break;case"map":S(typeof t=="object"&&t!=null);for(const[o,a]of Object.entries(t))Dn(n,r,e,o,a);break}}function Dn(e,t,n,r,i){e.tag(n.no,I.LengthDelimited),e.fork();let s=r;switch(n.K){case d.INT32:case d.FIXED32:case d.UINT32:case d.SFIXED32:case d.SINT32:s=Number.parseInt(r);break;case d.BOOL:S(r=="true"||r=="false"),s=r=="true";break}switch(Y(e,n.K,1,s),n.V.kind){case"scalar":Y(e,n.V.T,2,i);break;case"enum":Y(e,d.INT32,2,i);break;case"message":S(i!==void 0),e.tag(2,I.LengthDelimited).bytes(i.toBinary(t));break}e.join()}function pt(e,t,n,r){const i=st(n.T,r);n.delimited?e.tag(n.no,I.StartGroup).raw(i.toBinary(t)).tag(n.no,I.EndGroup):e.tag(n.no,I.LengthDelimited).bytes(i.toBinary(t))}function Y(e,t,n,r){S(r!==void 0);let[i,s]=gt(t);e.tag(n,i)[s](r)}function Mn(e,t,n,r){if(!r.length)return;e.tag(n,I.LengthDelimited).fork();let[,i]=gt(t);for(let s=0;s<r.length;s++)e[i](r[s]);e.join()}function gt(e){let t=I.Varint;switch(e){case d.BYTES:case d.STRING:t=I.LengthDelimited;break;case d.DOUBLE:case d.FIXED64:case d.SFIXED64:t=I.Bit64;break;case d.FIXED32:case d.SFIXED32:case d.FLOAT:t=I.Bit32;break}const n=d[e].toLowerCase();return[t,n]}function Pn(){return{setEnumType:je,initPartial(e,t){if(e===void 0)return;const n=t.getType();for(const r of n.fields.byMember()){const i=r.localName,s=t,o=e;if(o[i]!=null)switch(r.kind){case"oneof":const a=o[i].case;if(a===void 0)continue;const c=r.findField(a);let u=o[i].value;c&&c.kind=="message"&&!K(u,c.T)?u=new c.T(u):c&&c.kind==="scalar"&&c.T===d.BYTES&&(u=z(u)),s[i]={case:a,value:u};break;case"scalar":case"enum":let l=o[i];r.T===d.BYTES&&(l=r.repeated?l.map(z):z(l)),s[i]=l;break;case"map":switch(r.V.kind){case"scalar":case"enum":if(r.V.T===d.BYTES)for(const[b,N]of Object.entries(o[i]))s[i][b]=z(N);else Object.assign(s[i],o[i]);break;case"message":const h=r.V.T;for(const b of Object.keys(o[i])){let N=o[i][b];h.fieldWrapper||(N=new h(N)),s[i][b]=N}break}break;case"message":const f=r.T;if(r.repeated)s[i]=o[i].map(h=>K(h,f)?h:new f(h));else{const h=o[i];f.fieldWrapper?f.typeName==="google.protobuf.BytesValue"?s[i]=z(h):s[i]=h:s[i]=K(h,f)?h:new f(h)}break}}},equals(e,t,n){return t===n?!0:!t||!n?!1:e.fields.byMember().every(r=>{const i=t[r.localName],s=n[r.localName];if(r.repeated){if(i.length!==s.length)return!1;switch(r.kind){case"message":return i.every((o,a)=>r.T.equals(o,s[a]));case"scalar":return i.every((o,a)=>B(r.T,o,s[a]));case"enum":return i.every((o,a)=>B(d.INT32,o,s[a]))}throw new Error("repeated cannot contain ".concat(r.kind))}switch(r.kind){case"message":return r.T.equals(i,s);case"enum":return B(d.INT32,i,s);case"scalar":return B(r.T,i,s);case"oneof":if(i.case!==s.case)return!1;const o=r.findField(i.case);if(o===void 0)return!0;switch(o.kind){case"message":return o.T.equals(i.value,s.value);case"enum":return B(d.INT32,i.value,s.value);case"scalar":return B(o.T,i.value,s.value)}throw new Error("oneof cannot contain ".concat(o.kind));case"map":const a=Object.keys(i).concat(Object.keys(s));switch(r.V.kind){case"message":const c=r.V.T;return a.every(l=>c.equals(i[l],s[l]));case"enum":return a.every(l=>B(d.INT32,i[l],s[l]));case"scalar":const u=r.V.T;return a.every(l=>B(u,i[l],s[l]))}break}})},clone(e){const t=e.getType(),n=new t,r=n;for(const i of t.fields.byMember()){const s=e[i.localName];let o;if(i.repeated)o=s.map(pe);else if(i.kind=="map"){o=r[i.localName];for(const[a,c]of Object.entries(s))o[a]=pe(c)}else i.kind=="oneof"?o=i.findField(s.case)?{case:s.case,value:pe(s.value)}:{case:void 0}:o=pe(s);r[i.localName]=o}for(const i of t.runtime.bin.listUnknownFields(e))t.runtime.bin.onUnknownField(r,i.no,i.wireType,i.data);return n}}}function pe(e){if(e===void 0)return e;if(K(e))return e.clone();if(e instanceof Uint8Array){const t=new Uint8Array(e.byteLength);return t.set(e),t}return e}function z(e){return e instanceof Uint8Array?e:new Uint8Array(e)}function Bn(e,t,n){return{syntax:e,json:Cn(),bin:Fn(),util:Object.assign(Object.assign({},Pn()),{newFieldList:t,initFields:n}),makeMessageType(r,i,s){return ln(this,r,i,s)},makeEnum:dn,makeEnumType:Xe,getEnumType:un,makeExtension(r,i,s){return wn(this,r,i,s)}}}class xn{constructor(t,n){this._fields=t,this._normalizer=n}findJsonName(t){if(!this.jsonNames){const n={};for(const r of this.list())n[r.jsonName]=n[r.name]=r;this.jsonNames=n}return this.jsonNames[t]}find(t){if(!this.numbers){const n={};for(const r of this.list())n[r.no]=r;this.numbers=n}return this.numbers[t]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((t,n)=>t.no-n.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const t=this.members;let n;for(const r of this.list())r.oneof?r.oneof!==n&&(n=r.oneof,t.push(n)):t.push(r)}return this.members}}function yt(e,t){const n=mt(e);return t?n:Xn(jn(n))}function Rn(e){return yt(e,!1)}const Kn=mt;function mt(e){let t=!1;const n=[];for(let r=0;r<e.length;r++){let i=e.charAt(r);switch(i){case"_":t=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":n.push(i),t=!1;break;default:t&&(t=!1,i=i.toUpperCase()),n.push(i);break}}return n.join("")}const Vn=new Set(["constructor","toString","toJSON","valueOf"]),Gn=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),bt=e=>"".concat(e,"$"),jn=e=>Gn.has(e)?bt(e):e,Xn=e=>Vn.has(e)?bt(e):e;class Jn{constructor(t){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=t,this.localName=Rn(t)}addField(t){S(t.oneof===this,"field ".concat(t.name," not one of ").concat(this.name)),this.fields.push(t)}findField(t){if(!this._lookup){this._lookup=Object.create(null);for(let n=0;n<this.fields.length;n++)this._lookup[this.fields[n].localName]=this.fields[n]}return this._lookup[t]}}function qn(e,t){var n,r,i,s,o,a;const c=[];let u;for(const l of typeof e=="function"?e():e){const f=l;if(f.localName=yt(l.name,l.oneof!==void 0),f.jsonName=(n=l.jsonName)!==null&&n!==void 0?n:Kn(l.name),f.repeated=(r=l.repeated)!==null&&r!==void 0?r:!1,l.kind=="scalar"&&(f.L=(i=l.L)!==null&&i!==void 0?i:P.BIGINT),f.delimited=(s=l.delimited)!==null&&s!==void 0?s:!1,f.req=(o=l.req)!==null&&o!==void 0?o:!1,f.opt=(a=l.opt)!==null&&a!==void 0?a:!1,l.packed===void 0&&(f.packed=l.kind=="enum"||l.kind=="scalar"&&l.T!=d.BYTES&&l.T!=d.STRING),l.oneof!==void 0){const h=typeof l.oneof=="string"?l.oneof:l.oneof.name;(!u||u.name!=h)&&(u=new Jn(h)),f.oneof=u,u.addField(f)}c.push(f)}return c}const Le=Bn("proto3",e=>new xn(e,t=>qn(t)),e=>{for(const t of e.getType().fields.byMember()){if(t.opt)continue;const n=t.localName,r=e;if(t.repeated){r[n]=[];continue}switch(t.kind){case"oneof":r[n]={case:void 0};break;case"enum":r[n]=0;break;case"map":r[n]={};break;case"scalar":r[n]=G(t.T,t.L);break}}}),$=Le.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),_=Le.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),wt=Le.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),Hn=/version\/(\d+(\.?_?\d+)+)/i;let Fe;function kt(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(typeof navigator>"u")return;const n=navigator.userAgent.toLowerCase();if(Fe===void 0||t){const r=Wn.find(i=>{let{test:s}=i;return s.test(n)});Fe=r==null?void 0:r.describe(n)}return Fe}const Wn=[{test:/firefox|iceweasel|fxios/i,describe(e){return{name:"Firefox",version:ge(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,e),os:e.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:_e(e)}}},{test:/chrom|crios|crmo/i,describe(e){return{name:"Chrome",version:ge(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,e),os:e.toLowerCase().includes("crios")?"iOS":void 0,osVersion:_e(e)}}},{test:/safari|applewebkit/i,describe(e){return{name:"Safari",version:ge(Hn,e),os:e.includes("mobile/")?"iOS":"macOS",osVersion:_e(e)}}}];function ge(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const r=t.match(e);return r&&r.length>=n&&r[n]||""}function _e(e){return e.includes("mac os")?ge(/\(.+?(\d+_\d+(:?_\d+)?)/,e,1).replace(/_/g,"."):void 0}class w{constructor(t,n,r,i,s){if(typeof t=="object")this.width=t.width,this.height=t.height,this.aspectRatio=t.aspectRatio,this.encoding={maxBitrate:t.maxBitrate,maxFramerate:t.maxFramerate,priority:t.priority};else if(n!==void 0&&r!==void 0)this.width=t,this.height=n,this.aspectRatio=t/n,this.encoding={maxBitrate:r,maxFramerate:i,priority:s};else throw new TypeError("Unsupported options: provide at least width, height and maxBitrate")}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}var St;(function(e){e.telephone={maxBitrate:12e3},e.speech={maxBitrate:2e4},e.music={maxBitrate:32e3},e.musicStereo={maxBitrate:48e3},e.musicHighQuality={maxBitrate:64e3},e.musicHighQualityStereo={maxBitrate:96e3}})(St||(St={})),new w(160,90,9e4,20),new w(320,180,16e4,20),new w(384,216,18e4,20),new w(640,360,45e4,20),new w(960,540,8e5,25),new w(1280,720,17e5,30),new w(1920,1080,3e6,30),new w(2560,1440,5e6,30),new w(3840,2160,8e6,30),new w(160,120,7e4,20),new w(240,180,125e3,20),new w(320,240,14e4,20),new w(480,360,33e4,20),new w(640,480,5e5,20),new w(720,540,6e5,25),new w(960,720,13e5,30),new w(1440,1080,23e5,30),new w(1920,1440,38e5,30),new w(640,360,2e5,3,"medium"),new w(640,360,4e5,15,"medium"),new w(1280,720,8e5,5,"medium"),new w(1280,720,15e5,15,"medium"),new w(1280,720,2e6,30,"medium"),new w(1920,1080,25e5,15,"medium"),new w(1920,1080,5e6,30,"medium"),new w(0,0,7e6,30,"medium");var Ue={exports:{}},X=typeof Reflect=="object"?Reflect:null,It=X&&typeof X.apply=="function"?X.apply:function(t,n,r){return Function.prototype.apply.call(t,n,r)},ye;X&&typeof X.ownKeys=="function"?ye=X.ownKeys:Object.getOwnPropertySymbols?ye=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:ye=function(t){return Object.getOwnPropertyNames(t)};function Yn(e){console&&console.warn&&console.warn(e)}var vt=Number.isNaN||function(t){return t!==t};function m(){m.init.call(this)}Ue.exports=m,Ue.exports.once=Zn,m.EventEmitter=m,m.prototype._events=void 0,m.prototype._eventsCount=0,m.prototype._maxListeners=void 0;var Tt=10;function me(e){if(typeof e!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}Object.defineProperty(m,"defaultMaxListeners",{enumerable:!0,get:function(){return Tt},set:function(e){if(typeof e!="number"||e<0||vt(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");Tt=e}}),m.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},m.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||vt(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function Nt(e){return e._maxListeners===void 0?m.defaultMaxListeners:e._maxListeners}m.prototype.getMaxListeners=function(){return Nt(this)},m.prototype.emit=function(t){for(var n=[],r=1;r<arguments.length;r++)n.push(arguments[r]);var i=t==="error",s=this._events;if(s!==void 0)i=i&&s.error===void 0;else if(!i)return!1;if(i){var o;if(n.length>0&&(o=n[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[t];if(c===void 0)return!1;if(typeof c=="function")It(c,this,n);else for(var u=c.length,l=Lt(c,u),r=0;r<u;++r)It(l[r],this,n);return!0};function Ct(e,t,n,r){var i,s,o;if(me(n),s=e._events,s===void 0?(s=e._events=Object.create(null),e._eventsCount=0):(s.newListener!==void 0&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),o=s[t]),o===void 0)o=s[t]=n,++e._eventsCount;else if(typeof o=="function"?o=s[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),i=Nt(e),i>0&&o.length>i&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=t,a.count=o.length,Yn(a)}return e}m.prototype.addListener=function(t,n){return Ct(this,t,n,!1)},m.prototype.on=m.prototype.addListener,m.prototype.prependListener=function(t,n){return Ct(this,t,n,!0)};function zn(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Et(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=zn.bind(r);return i.listener=n,r.wrapFn=i,i}m.prototype.once=function(t,n){return me(n),this.on(t,Et(this,t,n)),this},m.prototype.prependOnceListener=function(t,n){return me(n),this.prependListener(t,Et(this,t,n)),this},m.prototype.removeListener=function(t,n){var r,i,s,o,a;if(me(n),i=this._events,i===void 0)return this;if(r=i[t],r===void 0)return this;if(r===n||r.listener===n)--this._eventsCount===0?this._events=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,r.listener||n));else if(typeof r!="function"){for(s=-1,o=r.length-1;o>=0;o--)if(r[o]===n||r[o].listener===n){a=r[o].listener,s=o;break}if(s<0)return this;s===0?r.shift():$n(r,s),r.length===1&&(i[t]=r[0]),i.removeListener!==void 0&&this.emit("removeListener",t,a||n)}return this},m.prototype.off=m.prototype.removeListener,m.prototype.removeAllListeners=function(t){var n,r,i;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[t]),this;if(arguments.length===0){var s=Object.keys(r),o;for(i=0;i<s.length;++i)o=s[i],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(n=r[t],typeof n=="function")this.removeListener(t,n);else if(n!==void 0)for(i=n.length-1;i>=0;i--)this.removeListener(t,n[i]);return this};function Ot(e,t,n){var r=e._events;if(r===void 0)return[];var i=r[t];return i===void 0?[]:typeof i=="function"?n?[i.listener||i]:[i]:n?Qn(i):Lt(i,i.length)}m.prototype.listeners=function(t){return Ot(this,t,!0)},m.prototype.rawListeners=function(t){return Ot(this,t,!1)},m.listenerCount=function(e,t){return typeof e.listenerCount=="function"?e.listenerCount(t):At.call(e,t)},m.prototype.listenerCount=At;function At(e){var t=this._events;if(t!==void 0){var n=t[e];if(typeof n=="function")return 1;if(n!==void 0)return n.length}return 0}m.prototype.eventNames=function(){return this._eventsCount>0?ye(this._events):[]};function Lt(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function $n(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function Qn(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}function Zn(e,t){return new Promise(function(n,r){function i(o){e.removeListener(t,s),r(o)}function s(){typeof e.removeListener=="function"&&e.removeListener("error",i),n([].slice.call(arguments))}Ft(e,t,s,{once:!0}),t!=="error"&&er(e,i,{once:!0})})}function er(e,t,n){typeof e.on=="function"&&Ft(e,"error",t,n)}function Ft(e,t,n,r){if(typeof e.on=="function")r.once?e.once(t,n):e.on(t,n);else if(typeof e.addEventListener=="function")e.addEventListener(t,function i(s){r.once&&e.removeEventListener(t,i),n(s)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}var De=Ue.exports,_t;(function(e){e.Connected="connected",e.Reconnecting="reconnecting",e.SignalReconnecting="signalReconnecting",e.Reconnected="reconnected",e.Disconnected="disconnected",e.ConnectionStateChanged="connectionStateChanged",e.MediaDevicesChanged="mediaDevicesChanged",e.ParticipantConnected="participantConnected",e.ParticipantDisconnected="participantDisconnected",e.TrackPublished="trackPublished",e.TrackSubscribed="trackSubscribed",e.TrackSubscriptionFailed="trackSubscriptionFailed",e.TrackUnpublished="trackUnpublished",e.TrackUnsubscribed="trackUnsubscribed",e.TrackMuted="trackMuted",e.TrackUnmuted="trackUnmuted",e.LocalTrackPublished="localTrackPublished",e.LocalTrackUnpublished="localTrackUnpublished",e.LocalAudioSilenceDetected="localAudioSilenceDetected",e.ActiveSpeakersChanged="activeSpeakersChanged",e.ParticipantMetadataChanged="participantMetadataChanged",e.ParticipantNameChanged="participantNameChanged",e.ParticipantAttributesChanged="participantAttributesChanged",e.RoomMetadataChanged="roomMetadataChanged",e.DataReceived="dataReceived",e.SipDTMFReceived="sipDTMFReceived",e.TranscriptionReceived="transcriptionReceived",e.ConnectionQualityChanged="connectionQualityChanged",e.TrackStreamStateChanged="trackStreamStateChanged",e.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",e.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",e.AudioPlaybackStatusChanged="audioPlaybackChanged",e.VideoPlaybackStatusChanged="videoPlaybackChanged",e.MediaDevicesError="mediaDevicesError",e.ParticipantPermissionsChanged="participantPermissionsChanged",e.SignalConnected="signalConnected",e.RecordingStatusChanged="recordingStatusChanged",e.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",e.EncryptionError="encryptionError",e.DCBufferStatusChanged="dcBufferStatusChanged",e.ActiveDeviceChanged="activeDeviceChanged",e.ChatMessage="chatMessage",e.LocalTrackSubscribed="localTrackSubscribed"})(_t||(_t={}));var Ut;(function(e){e.TrackPublished="trackPublished",e.TrackSubscribed="trackSubscribed",e.TrackSubscriptionFailed="trackSubscriptionFailed",e.TrackUnpublished="trackUnpublished",e.TrackUnsubscribed="trackUnsubscribed",e.TrackMuted="trackMuted",e.TrackUnmuted="trackUnmuted",e.LocalTrackPublished="localTrackPublished",e.LocalTrackUnpublished="localTrackUnpublished",e.ParticipantMetadataChanged="participantMetadataChanged",e.ParticipantNameChanged="participantNameChanged",e.DataReceived="dataReceived",e.SipDTMFReceived="sipDTMFReceived",e.TranscriptionReceived="transcriptionReceived",e.IsSpeakingChanged="isSpeakingChanged",e.ConnectionQualityChanged="connectionQualityChanged",e.TrackStreamStateChanged="trackStreamStateChanged",e.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",e.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",e.MediaDevicesError="mediaDevicesError",e.AudioStreamAcquired="audioStreamAcquired",e.ParticipantPermissionsChanged="participantPermissionsChanged",e.PCTrackAdded="pcTrackAdded",e.AttributesChanged="attributesChanged",e.LocalTrackSubscribed="localTrackSubscribed",e.ChatMessage="chatMessage"})(Ut||(Ut={}));var Dt;(function(e){e.TransportsCreated="transportsCreated",e.Connected="connected",e.Disconnected="disconnected",e.Resuming="resuming",e.Resumed="resumed",e.Restarting="restarting",e.Restarted="restarted",e.SignalResumed="signalResumed",e.SignalRestarted="signalRestarted",e.Closing="closing",e.MediaTrackAdded="mediaTrackAdded",e.ActiveSpeakersUpdate="activeSpeakersUpdate",e.DataPacketReceived="dataPacketReceived",e.RTPVideoMapUpdate="rtpVideoMapUpdate",e.DCBufferStatusChanged="dcBufferStatusChanged",e.ParticipantUpdate="participantUpdate",e.RoomUpdate="roomUpdate",e.SpeakersChanged="speakersChanged",e.StreamStateChanged="streamStateChanged",e.ConnectionQualityUpdate="connectionQualityUpdate",e.SubscriptionError="subscriptionError",e.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",e.RemoteMute="remoteMute",e.SubscribedQualityUpdate="subscribedQualityUpdate",e.LocalTrackUnpublished="localTrackUnpublished",e.LocalTrackSubscribed="localTrackSubscribed",e.Offline="offline",e.SignalRequestResponse="signalRequestResponse"})(Dt||(Dt={}));var U;(function(e){e.Message="message",e.Muted="muted",e.Unmuted="unmuted",e.Restarted="restarted",e.Ended="ended",e.Subscribed="subscribed",e.Unsubscribed="unsubscribed",e.UpdateSettings="updateSettings",e.UpdateSubscription="updateSubscription",e.AudioPlaybackStarted="audioPlaybackStarted",e.AudioPlaybackFailed="audioPlaybackFailed",e.AudioSilenceDetected="audioSilenceDetected",e.VisibilityChanged="visibilityChanged",e.VideoDimensionsChanged="videoDimensionsChanged",e.VideoPlaybackStarted="videoPlaybackStarted",e.VideoPlaybackFailed="videoPlaybackFailed",e.ElementAttached="elementAttached",e.ElementDetached="elementDetached",e.UpstreamPaused="upstreamPaused",e.UpstreamResumed="upstreamResumed",e.SubscriptionPermissionChanged="subscriptionPermissionChanged",e.SubscriptionStatusChanged="subscriptionStatusChanged",e.SubscriptionFailed="subscriptionFailed",e.TrackProcessorUpdate="trackProcessorUpdate",e.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",e.TranscriptionReceived="transcriptionReceived",e.TimeSyncUpdate="timeSyncUpdate"})(U||(U={}));const tr=5e3,Q=[];var Mt;(function(e){e[e.LOW=0]="LOW",e[e.MEDIUM=1]="MEDIUM",e[e.HIGH=2]="HIGH"})(Mt||(Mt={}));class D extends De.EventEmitter{constructor(t,n){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var i;super(),this.attachedElements=[],this.isMuted=!1,this.streamState=D.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=H,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),document.visibilityState==="hidden"?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),tr):this.handleAppVisibilityChanged()},this.log=Ke((i=r.loggerName)!==null&&i!==void 0?i:se.Track),this.loggerContextCb=r.loggerContextCb,this.setMaxListeners(100),this.kind=n,this._mediaStreamTrack=t,this._mediaStreamID=t.id,this.source=D.Source.Unknown}get logContext(){var t;return Object.assign(Object.assign({},(t=this.loggerContextCb)===null||t===void 0?void 0:t.call(this)),Bt(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(t){let n="audio";this.kind===D.Kind.Video&&(n="video"),this.attachedElements.length===0&&this.kind===D.Kind.Video&&this.addAppVisibilityListener(),t||(n==="audio"&&(Q.forEach(s=>{s.parentElement===null&&!t&&(t=s)}),t&&Q.splice(Q.indexOf(t),1)),t||(t=document.createElement(n))),this.attachedElements.includes(t)||this.attachedElements.push(t),nr(this.mediaStreamTrack,t);const r=t.srcObject.getTracks(),i=r.some(s=>s.kind==="audio");return t.play().then(()=>{this.emit(i?U.AudioPlaybackStarted:U.VideoPlaybackStarted)}).catch(s=>{s.name==="NotAllowedError"?this.emit(i?U.AudioPlaybackFailed:U.VideoPlaybackFailed,s):s.name==="AbortError"?H.debug("".concat(i?"audio":"video"," playback aborted, likely due to new play request")):H.warn("could not playback ".concat(i?"audio":"video"),s),i&&t&&r.some(o=>o.kind==="video")&&s.name==="NotAllowedError"&&(t.muted=!0,t.play().catch(()=>{}))}),this.emit(U.ElementAttached,t),t}detach(t){try{if(t){Pt(this.mediaStreamTrack,t);const r=this.attachedElements.indexOf(t);return r>=0&&(this.attachedElements.splice(r,1),this.recycleElement(t),this.emit(U.ElementDetached,t)),t}const n=[];return this.attachedElements.forEach(r=>{Pt(this.mediaStreamTrack,r),n.push(r),this.recycleElement(r),this.emit(U.ElementDetached,r)}),this.attachedElements=[],n}finally{this.attachedElements.length===0&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions(t){t.loggerName&&(this.log=Ke(t.loggerName)),t.loggerContextCb&&(this.loggerContextCb=t.loggerContextCb)}recycleElement(t){if(t instanceof HTMLAudioElement){let n=!0;t.pause(),Q.forEach(r=>{r.parentElement||(n=!1)}),n&&Q.push(t)}}handleAppVisibilityChanged(){return T(this,void 0,void 0,function*(){this.isInBackground=document.visibilityState==="hidden",!this.isInBackground&&this.kind===D.Kind.Video&&setTimeout(()=>this.attachedElements.forEach(t=>t.play().catch(()=>{})),0)})}addAppVisibilityListener(){Rt()?(this.isInBackground=document.visibilityState==="hidden",document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){Rt()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function nr(e,t){let n;t.srcObject instanceof MediaStream?n=t.srcObject:n=new MediaStream;let r;e.kind==="audio"?r=n.getAudioTracks():r=n.getVideoTracks(),r.includes(e)||(r.forEach(i=>{n.removeTrack(i)}),n.addTrack(e)),(!xt()||!(t instanceof HTMLVideoElement))&&(t.autoplay=!0),t.muted=n.getAudioTracks().length===0,t instanceof HTMLVideoElement&&(t.playsInline=!0),t.srcObject!==n&&(t.srcObject=n,(xt()||rr())&&t instanceof HTMLVideoElement&&setTimeout(()=>{t.srcObject=n,t.play().catch(()=>{})},0))}function Pt(e,t){if(t.srcObject instanceof MediaStream){const n=t.srcObject;n.removeTrack(e),n.getTracks().length>0?t.srcObject=n:t.srcObject=null}}(function(e){let t;(function(u){u.Audio="audio",u.Video="video",u.Unknown="unknown"})(t=e.Kind||(e.Kind={}));let n;(function(u){u.Camera="camera",u.Microphone="microphone",u.ScreenShare="screen_share",u.ScreenShareAudio="screen_share_audio",u.Unknown="unknown"})(n=e.Source||(e.Source={}));let r;(function(u){u.Active="active",u.Paused="paused",u.Unknown="unknown"})(r=e.StreamState||(e.StreamState={}));function i(u){switch(u){case t.Audio:return $.AUDIO;case t.Video:return $.VIDEO;default:return $.DATA}}e.kindToProto=i;function s(u){switch(u){case $.AUDIO:return t.Audio;case $.VIDEO:return t.Video;default:return t.Unknown}}e.kindFromProto=s;function o(u){switch(u){case n.Camera:return _.CAMERA;case n.Microphone:return _.MICROPHONE;case n.ScreenShare:return _.SCREEN_SHARE;case n.ScreenShareAudio:return _.SCREEN_SHARE_AUDIO;default:return _.UNKNOWN}}e.sourceToProto=o;function a(u){switch(u){case _.CAMERA:return n.Camera;case _.MICROPHONE:return n.Microphone;case _.SCREEN_SHARE:return n.ScreenShare;case _.SCREEN_SHARE_AUDIO:return n.ScreenShareAudio;default:return n.Unknown}}e.sourceFromProto=a;function c(u){switch(u){case wt.ACTIVE:return r.Active;case wt.PAUSED:return r.Paused;default:return r.Unknown}}e.streamStateFromProto=c})(D||(D={}));function Bt(e){return e instanceof D?{trackID:e.sid,source:e.source,muted:e.isMuted,enabled:e.mediaStreamTrack.enabled,kind:e.kind,streamID:e.mediaStreamID,streamTrackID:e.mediaStreamTrack.id}:{trackID:e.trackSid,enabled:e.isEnabled,muted:e.isMuted,trackInfo:Object.assign({mimeType:e.mimeType,name:e.trackName,encrypted:e.isEncrypted,kind:e.kind,source:e.source},e.track?Bt(e.track):{})}}function rr(){var e;return((e=kt())===null||e===void 0?void 0:e.name)==="Firefox"}function xt(){var e;return((e=kt())===null||e===void 0?void 0:e.name)==="Safari"}function Rt(){return typeof document<"u"}class ir{constructor(){this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let t;const n=new Promise(i=>t=()=>{this._locks-=1,i()}),r=this._locking.then(()=>t);return this._locking=this._locking.then(()=>n),r}}var Z;(function(e){e[e.WAITING=0]="WAITING",e[e.RUNNING=1]="RUNNING",e[e.COMPLETED=2]="COMPLETED"})(Z||(Z={}));class sr{constructor(){this.pendingTasks=new Map,this.taskMutex=new ir,this.nextTaskIndex=0}run(t){return T(this,void 0,void 0,function*(){const n={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:Z.WAITING};this.pendingTasks.set(n.id,n);const r=yield this.taskMutex.lock();try{return n.executedAt=Date.now(),n.status=Z.RUNNING,yield t()}finally{n.status=Z.COMPLETED,this.pendingTasks.delete(n.id),r()}})}flush(){return T(this,void 0,void 0,function*(){return this.run(()=>T(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}const be="AES-GCM",or=10,Me={key:10,delta:3,audio:1,empty:0},Kt=12,ar={sharedKey:!1,ratchetSalt:"LKFrameEncryptionKey",ratchetWindowSize:8,failureTolerance:or,keyringSize:16},cr=100,Vt=2e3;class ur extends Error{constructor(t,n){super(n||"an error has occured"),this.code=t}}var we;(function(e){e.PermissionDenied="PermissionDenied",e.NotFound="NotFound",e.DeviceInUse="DeviceInUse",e.Other="Other"})(we||(we={})),function(e){function t(n){if(n&&"name"in n)return n.name==="NotFoundError"||n.name==="DevicesNotFoundError"?e.NotFound:n.name==="NotAllowedError"||n.name==="PermissionDeniedError"?e.PermissionDenied:n.name==="NotReadableError"||n.name==="TrackStartError"?e.DeviceInUse:e.Other}e.getFailure=t}(we||(we={}));var L;(function(e){e[e.InvalidKey=0]="InvalidKey",e[e.MissingKey=1]="MissingKey",e[e.InternalError=2]="InternalError"})(L||(L={}));class x extends ur{constructor(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:L.InternalError,r=arguments.length>2?arguments[2]:void 0;super(40,t),this.reason=n,this.participantIdentity=r}}var Gt;(function(e){e.SetKey="setKey",e.RatchetRequest="ratchetRequest",e.KeyRatcheted="keyRatcheted"})(Gt||(Gt={}));var ee;(function(e){e.KeyRatcheted="keyRatcheted"})(ee||(ee={}));var jt;(function(e){e.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",e.EncryptionError="encryptionError"})(jt||(jt={}));var R;(function(e){e.Error="cryptorError"})(R||(R={}));function dr(e){return"type"in e}function lr(e){return T(this,arguments,void 0,function(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{name:be},r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"encrypt";return function*(){return crypto.subtle.importKey("raw",t,n,!1,r==="derive"?["deriveBits","deriveKey"]:["encrypt","decrypt"])}()})}function Xt(e,t){const r=new TextEncoder().encode(t);switch(e){case"HKDF":return{name:"HKDF",salt:r,hash:"SHA-256",info:new ArrayBuffer(128)};case"PBKDF2":return{name:"PBKDF2",salt:r,hash:"SHA-256",iterations:1e5};default:throw new Error("algorithm ".concat(e," is currently unsupported"))}}function Jt(e,t){return T(this,void 0,void 0,function*(){const n=Xt(e.algorithm.name,t),r=yield crypto.subtle.deriveKey(n,e,{name:be,length:128},!1,["encrypt","decrypt"]);return{material:e,encryptionKey:r}})}function fr(e,t){return T(this,void 0,void 0,function*(){const n=Xt(e.algorithm.name,t);return crypto.subtle.deriveBits(n,e,256)})}function hr(e){for(var t=0;t<e.length-3;t++)if(e[t]==0&&e[t+1]==0&&e[t+2]==3)return!0;return!1}function pr(e){const t=[];for(var n=e.length,r=0;r<e.length;)n-r>=3&&!e[r]&&!e[r+1]&&e[r+2]==3?(t.push(e[r++]),t.push(e[r++]),r++):t.push(e[r++]);return new Uint8Array(t)}const gr=2,qt=3;function yr(e){const t=[];for(var n=0,r=0;r<e.length;++r){var i=e[r];i<=qt&&n>=gr&&(t.push(qt),n=0),t.push(i),i==0?++n:n=0}return new Uint8Array(t)}class mr{constructor(){this.consecutiveSifCount=0,this.lastSifReceivedAt=0,this.userFramesSinceSif=0}recordSif(){var t;this.consecutiveSifCount+=1,(t=this.sifSequenceStartedAt)!==null&&t!==void 0||(this.sifSequenceStartedAt=Date.now()),this.lastSifReceivedAt=Date.now()}recordUserFrame(){this.sifSequenceStartedAt!==void 0&&(this.userFramesSinceSif+=1,(this.userFramesSinceSif>this.consecutiveSifCount||Date.now()-this.lastSifReceivedAt>Vt)&&this.reset())}isSifAllowed(){return this.consecutiveSifCount<cr&&(this.sifSequenceStartedAt===void 0||Date.now()-this.sifSequenceStartedAt<Vt)}reset(){this.userFramesSinceSif=0,this.consecutiveSifCount=0,this.sifSequenceStartedAt=void 0}}const Ht=new Map;class br extends De.EventEmitter{encodeFunction(t,n){throw Error("not implemented for subclass")}decodeFunction(t,n){throw Error("not implemented for subclass")}}class wr extends br{constructor(t){var n;super(),this.sendCounts=new Map,this.keys=t.keys,this.participantIdentity=t.participantIdentity,this.rtpMap=new Map,this.keyProviderOptions=t.keyProviderOptions,this.sifTrailer=(n=t.sifTrailer)!==null&&n!==void 0?n:Uint8Array.from([]),this.sifGuard=new mr}get logContext(){return{participant:this.participantIdentity,mediaTrackId:this.trackId,fallbackCodec:this.videoCodec}}setParticipant(t,n){g.debug("setting new participant on cryptor",Object.assign(Object.assign({},this.logContext),{participant:t})),this.participantIdentity&&g.error("cryptor has already a participant set, participant should have been unset before",Object.assign({},this.logContext)),this.participantIdentity=t,this.keys=n,this.sifGuard.reset()}unsetParticipant(){g.debug("unsetting participant",this.logContext),this.participantIdentity=void 0}isEnabled(){if(this.participantIdentity)return Ht.get(this.participantIdentity)}getParticipantIdentity(){return this.participantIdentity}getTrackId(){return this.trackId}setVideoCodec(t){this.videoCodec=t}setRtpMap(t){this.rtpMap=t}setupTransform(t,n,r,i,s){s&&(g.info("setting codec on cryptor to",{codec:s}),this.videoCodec=s),g.debug("Setting up frame cryptor transform",Object.assign({operation:t,passedTrackId:i,codec:s},this.logContext));const o=t==="encode"?this.encodeFunction:this.decodeFunction,a=new TransformStream({transform:o.bind(this)});n.pipeThrough(a).pipeTo(r).catch(c=>{g.warn(c),this.emit(R.Error,c instanceof x?c:new x(c.message,void 0,this.participantIdentity))}),this.trackId=i}setSifTrailer(t){g.debug("setting SIF trailer",Object.assign(Object.assign({},this.logContext),{trailer:t})),this.sifTrailer=t}encodeFunction(t,n){return T(this,void 0,void 0,function*(){var r;if(!this.isEnabled()||t.data.byteLength===0)return n.enqueue(t);const i=this.keys.getKeySet();if(!i){this.emit(R.Error,new x("key set not found for ".concat(this.participantIdentity," at index ").concat(this.keys.getCurrentKeyIndex()),L.MissingKey,this.participantIdentity));return}const{encryptionKey:s}=i,o=this.keys.getCurrentKeyIndex();if(s){const c=this.makeIV((r=t.getMetadata().synchronizationSource)!==null&&r!==void 0?r:-1,t.timestamp);let u=this.getUnencryptedBytes(t);const l=new Uint8Array(t.data,0,u.unencryptedBytes),f=new Uint8Array(2);f[0]=Kt,f[1]=o;try{const h=yield crypto.subtle.encrypt({name:be,iv:c,additionalData:new Uint8Array(t.data,0,l.byteLength)},s,new Uint8Array(t.data,u.unencryptedBytes));let b=new Uint8Array(h.byteLength+c.byteLength+f.byteLength);b.set(new Uint8Array(h)),b.set(new Uint8Array(c),h.byteLength),b.set(f,h.byteLength+c.byteLength),u.isH264&&(b=yr(b));var a=new Uint8Array(l.byteLength+b.byteLength);return a.set(l),a.set(b,l.byteLength),t.data=a.buffer,n.enqueue(t)}catch(h){g.error(h)}}else g.debug("failed to encrypt, emitting error",this.logContext),this.emit(R.Error,new x("encryption key missing for encoding",L.MissingKey,this.participantIdentity))})}decodeFunction(t,n){return T(this,void 0,void 0,function*(){if(!this.isEnabled()||t.data.byteLength===0)return g.debug("skipping empty frame",this.logContext),this.sifGuard.recordUserFrame(),n.enqueue(t);if(Ir(t.data,this.sifTrailer)){if(g.debug("enqueue SIF",this.logContext),this.sifGuard.recordSif(),this.sifGuard.isSifAllowed())return t.data=t.data.slice(0,t.data.byteLength-this.sifTrailer.byteLength),n.enqueue(t);g.warn("SIF limit reached, dropping frame");return}else this.sifGuard.recordUserFrame();const i=new Uint8Array(t.data)[t.data.byteLength-1];if(this.keys.getKeySet(i)&&this.keys.hasValidKey)try{const s=yield this.decryptFrame(t,i);if(this.keys.decryptionSuccess(),s)return n.enqueue(s)}catch(s){s instanceof x&&s.reason===L.InvalidKey?this.keys.hasValidKey&&(this.emit(R.Error,s),this.keys.decryptionFailure()):g.warn("decoding frame failed",{error:s})}else!this.keys.getKeySet(i)&&this.keys.hasValidKey&&(g.warn("skipping decryption due to missing key at index ".concat(i)),this.emit(R.Error,new x("missing key at index ".concat(i," for participant ").concat(this.participantIdentity),L.MissingKey,this.participantIdentity)),this.keys.decryptionFailure())})}decryptFrame(t,n){return T(this,arguments,void 0,function(r,i){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:void 0,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{ratchetCount:0};return function*(){var c;const u=s.keys.getKeySet(i);if(!a.encryptionKey&&!u)throw new TypeError("no encryption key found for decryption of ".concat(s.participantIdentity));let l=s.getUnencryptedBytes(r);try{const h=new Uint8Array(r.data,0,l.unencryptedBytes);var f=new Uint8Array(r.data,h.length,r.data.byteLength-h.length);if(l.isH264&&hr(f)){f=pr(f);const E=new Uint8Array(h.byteLength+f.byteLength);E.set(h),E.set(f,h.byteLength),r.data=E.buffer}const b=new Uint8Array(r.data,r.data.byteLength-2,2),N=b[0],y=new Uint8Array(r.data,r.data.byteLength-N-b.byteLength,N),v=h.byteLength,p=r.data.byteLength-(h.byteLength+N+b.byteLength),V=yield crypto.subtle.decrypt({name:be,iv:y,additionalData:new Uint8Array(r.data,0,h.byteLength)},(c=a.encryptionKey)!==null&&c!==void 0?c:u.encryptionKey,new Uint8Array(r.data,v,p)),q=new ArrayBuffer(h.byteLength+V.byteLength),M=new Uint8Array(q);return M.set(new Uint8Array(r.data,0,h.byteLength)),M.set(new Uint8Array(V),h.byteLength),r.data=q,r}catch(h){if(s.keyProviderOptions.ratchetWindowSize>0)if(a.ratchetCount<s.keyProviderOptions.ratchetWindowSize){g.debug("ratcheting key attempt ".concat(a.ratchetCount," of ").concat(s.keyProviderOptions.ratchetWindowSize,", for kind ").concat(r instanceof RTCEncodedAudioFrame?"audio":"video"));let b;if((o??u)===s.keys.getKeySet(i)){const y=yield s.keys.ratchetKey(i,!1);b=yield Jt(y,s.keyProviderOptions.ratchetSalt)}const N=yield s.decryptFrame(r,i,o||u,{ratchetCount:a.ratchetCount+1,encryptionKey:b==null?void 0:b.encryptionKey});return N&&b&&(o??u)===s.keys.getKeySet(i)&&(s.keys.setKeySet(b,i,!0),s.keys.setCurrentKeyIndex(i)),N}else throw g.warn("maximum ratchet attempts exceeded"),new x("valid key missing for participant ".concat(s.participantIdentity),L.InvalidKey,s.participantIdentity);else throw new x("Decryption failed: ".concat(h.message),L.InvalidKey,s.participantIdentity)}}()})}makeIV(t,n){var r;const i=new ArrayBuffer(Kt),s=new DataView(i);this.sendCounts.has(t)||this.sendCounts.set(t,Math.floor(Math.random()*65535));const o=(r=this.sendCounts.get(t))!==null&&r!==void 0?r:0;return s.setUint32(0,t),s.setUint32(4,n),s.setUint32(8,n-o%65535),this.sendCounts.set(t,o+1),i}getUnencryptedBytes(t){var n,r={unencryptedBytes:0,isH264:!1};if(dr(t)){let i=(n=this.getVideoCodec(t))!==null&&n!==void 0?n:this.videoCodec;if(i!==this.detectedCodec&&(g.debug("detected different codec",Object.assign({detectedCodec:i,oldCodec:this.detectedCodec},this.logContext)),this.detectedCodec=i),i==="av1")throw new Error("".concat(i," is not yet supported for end to end encryption"));if(i==="vp8")r.unencryptedBytes=Me[t.type];else if(i==="vp9")return r.unencryptedBytes=0,r;const s=new Uint8Array(t.data);try{const o=kr(s);if(r.isH264=i==="h264"||o.some(a=>[J.SLICE_IDR,J.SLICE_NON_IDR].includes(Wt(s[a]))),r.isH264){for(const a of o)switch(Wt(s[a])){case J.SLICE_IDR:case J.SLICE_NON_IDR:return r.unencryptedBytes=a+2,r;default:break}throw new TypeError("Could not find NALU")}}catch{}return r.unencryptedBytes=Me[t.type],r}else return r.unencryptedBytes=Me.audio,r}getVideoCodec(t){if(this.rtpMap.size===0)return;const n=t.getMetadata().payloadType;return n?this.rtpMap.get(n):void 0}}function kr(e){const t=[];let n=0,r=0,i=e.length-2;for(;r<i;){for(;r<i&&!(e[r]===0&&e[r+1]===0&&e[r+2]===1);)r++;r>=i&&(r=e.length);let s=r;for(;s>n&&e[s-1]===0;)s--;if(n===0){if(s!==n)throw TypeError("byte stream contains leading data")}else t.push(n);n=r=r+3}return t}function Wt(e){return e&Sr}const Sr=31;var J;(function(e){e[e.SLICE_NON_IDR=1]="SLICE_NON_IDR",e[e.SLICE_PARTITION_A=2]="SLICE_PARTITION_A",e[e.SLICE_PARTITION_B=3]="SLICE_PARTITION_B",e[e.SLICE_PARTITION_C=4]="SLICE_PARTITION_C",e[e.SLICE_IDR=5]="SLICE_IDR",e[e.SEI=6]="SEI",e[e.SPS=7]="SPS",e[e.PPS=8]="PPS",e[e.AUD=9]="AUD",e[e.END_SEQ=10]="END_SEQ",e[e.END_STREAM=11]="END_STREAM",e[e.FILLER_DATA=12]="FILLER_DATA",e[e.SPS_EXT=13]="SPS_EXT",e[e.PREFIX_NALU=14]="PREFIX_NALU",e[e.SUBSET_SPS=15]="SUBSET_SPS",e[e.DPS=16]="DPS",e[e.SLICE_AUX=19]="SLICE_AUX",e[e.SLICE_EXT=20]="SLICE_EXT",e[e.SLICE_LAYER_EXT=21]="SLICE_LAYER_EXT"})(J||(J={}));function Ir(e,t){if(t.byteLength===0)return!1;const n=new Uint8Array(e.slice(e.byteLength-t.byteLength));return t.every((r,i)=>r===n[i])}class Yt extends De.EventEmitter{get hasValidKey(){return this._hasValidKey}constructor(t,n){if(super(),this.decryptionFailureCount=0,this._hasValidKey=!0,this.currentKeyIndex=0,n.keyringSize<1||n.keyringSize>255)throw new TypeError("Keyring size needs to be between 1 and 256");this.cryptoKeyRing=new Array(n.keyringSize).fill(void 0),this.keyProviderOptions=n,this.ratchetPromiseMap=new Map,this.participantIdentity=t,this.resetKeyStatus()}decryptionFailure(){this.keyProviderOptions.failureTolerance<0||(this.decryptionFailureCount+=1,this.decryptionFailureCount>this.keyProviderOptions.failureTolerance&&(g.warn("key for ".concat(this.participantIdentity," is being marked as invalid")),this._hasValidKey=!1))}decryptionSuccess(){this.resetKeyStatus()}resetKeyStatus(){this.decryptionFailureCount=0,this._hasValidKey=!0}ratchetKey(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;const r=t??this.getCurrentKeyIndex(),i=this.ratchetPromiseMap.get(r);if(typeof i<"u")return i;const s=new Promise((o,a)=>T(this,void 0,void 0,function*(){try{const c=this.getKeySet(r);if(!c)throw new TypeError("Cannot ratchet key without a valid keyset of participant ".concat(this.participantIdentity));const u=c.material,l=yield lr(yield fr(u,this.keyProviderOptions.ratchetSalt),u.algorithm.name,"derive");n&&(this.setKeyFromMaterial(l,r,!0),this.emit(ee.KeyRatcheted,l,this.participantIdentity,r)),o(l)}catch(c){a(c)}finally{this.ratchetPromiseMap.delete(r)}}));return this.ratchetPromiseMap.set(r,s),s}setKey(t){return T(this,arguments,void 0,function(n){var r=this;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return function*(){yield r.setKeyFromMaterial(n,i),r.resetKeyStatus()}()})}setKeyFromMaterial(t,n){return T(this,arguments,void 0,function(r,i){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return function*(){const a=yield Jt(r,s.keyProviderOptions.ratchetSalt),c=i>=0?i%s.cryptoKeyRing.length:s.currentKeyIndex;g.debug("setting new key with index ".concat(i),{usage:r.usages,algorithm:r.algorithm,ratchetSalt:s.keyProviderOptions.ratchetSalt}),s.setKeySet(a,c,o),c>=0&&(s.currentKeyIndex=c)}()})}setKeySet(t,n){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;this.cryptoKeyRing[n%this.cryptoKeyRing.length]=t,r&&this.emit(ee.KeyRatcheted,t.material,this.participantIdentity,n)}setCurrentKeyIndex(t){return T(this,void 0,void 0,function*(){this.currentKeyIndex=t%this.cryptoKeyRing.length,this.resetKeyStatus()})}getCurrentKeyIndex(){return this.currentKeyIndex}getKeySet(t){return this.cryptoKeyRing[t??this.currentKeyIndex]}}const te=[],zt=new Map;let Pe,vr=new sr,Tr=!1,ke=!1,$t,ne=ar,Qt=new Map;g.setDefaultLevel("info"),onmessage=e=>{vr.run(()=>T(void 0,void 0,void 0,function*(){const{kind:t,data:n}=e.data;switch(t){case"init":g.setLevel(n.loglevel),g.info("worker initialized"),ne=n.keyProviderOptions,ke=!!n.keyProviderOptions.sharedKey,postMessage({kind:"initAck",data:{enabled:Tr}});break;case"enable":Er(n.enabled,n.participantIdentity),g.info("updated e2ee enabled status for ".concat(n.participantIdentity," to ").concat(n.enabled)),postMessage(e.data);break;case"decode":Se(n.participantIdentity,n.trackId).setupTransform(t,n.readableStream,n.writableStream,n.trackId,n.codec);break;case"encode":Se(n.participantIdentity,n.trackId).setupTransform(t,n.readableStream,n.writableStream,n.trackId,n.codec);break;case"setKey":ke?yield Or(n.key,n.keyIndex):n.participantIdentity?(g.info("set participant sender key ".concat(n.participantIdentity," index ").concat(n.keyIndex)),yield Ie(n.participantIdentity).setKey(n.key,n.keyIndex)):g.error("no participant Id was provided and shared key usage is disabled");break;case"removeTransform":Cr(n.trackId,n.participantIdentity);break;case"updateCodec":Se(n.participantIdentity,n.trackId).setVideoCodec(n.codec);break;case"setRTPMap":Qt=n.map,te.forEach(o=>{o.getParticipantIdentity()===n.participantIdentity&&o.setRtpMap(n.map)});break;case"ratchetRequest":Nr(n);break;case"setSifTrailer":Fr(n.trailer);break}}))};function Nr(e){return T(this,void 0,void 0,function*(){if(ke){const t=Be();yield t.ratchetKey(e.keyIndex),t.resetKeyStatus()}else if(e.participantIdentity){const t=Ie(e.participantIdentity);yield t.ratchetKey(e.keyIndex),t.resetKeyStatus()}else g.error("no participant Id was provided for ratchet request and shared key usage is disabled")})}function Se(e,t){let n=te.filter(i=>i.getTrackId()===t);if(n.length>1){const i=n.map(s=>({participant:s.getParticipantIdentity()})).join(",");g.error("Found multiple cryptors for the same trackID ".concat(t,". target participant: ").concat(e," "),{participants:i})}let r=n[0];if(r)e!==r.getParticipantIdentity()&&r.setParticipant(e,Ie(e));else{if(g.info("creating new cryptor for",{participantIdentity:e}),!ne)throw Error("Missing keyProvider options");r=new wr({participantIdentity:e,keys:Ie(e),keyProviderOptions:ne,sifTrailer:$t}),r.setRtpMap(Qt),Ar(r),te.push(r)}return r}function Ie(e){if(ke)return Be();let t=zt.get(e);return t||(t=new Yt(e,ne),t.on(ee.KeyRatcheted,Lr),zt.set(e,t)),t}function Be(){return Pe||(g.debug("creating new shared key handler"),Pe=new Yt("shared-key",ne)),Pe}function Cr(e,t){const n=te.filter(i=>i.getParticipantIdentity()===t&&i.getTrackId()===e);n.length>1&&g.error("Found multiple cryptors for the same participant and trackID combination",{trackId:e,participantIdentity:t});const r=n[0];r?r.unsetParticipant():g.warn("Could not unset participant on cryptor",{trackId:e,participantIdentity:t})}function Er(e,t){g.debug("setting encryption enabled for all tracks of ".concat(t),{enable:e}),Ht.set(t,e)}function Or(e,t){return T(this,void 0,void 0,function*(){g.info("set shared key",{index:t}),yield Be().setKey(e,t)})}function Ar(e){e.on(R.Error,t=>{const n={kind:"error",data:{error:new Error("".concat(L[t.reason],": ").concat(t.message))}};postMessage(n)})}function Lr(e,t,n){postMessage({kind:"ratchetKey",data:{participantIdentity:t,keyIndex:n,material:e}})}function Fr(e){$t=e,te.forEach(t=>{t.setSifTrailer(e)})}self.RTCTransformEvent&&(g.debug("setup transform event"),self.onrtctransform=e=>{const t=e.transformer;g.debug("transformer",t),t.handled=!0;const{kind:n,participantIdentity:r,trackId:i,codec:s}=t.options,o=Se(r,i);g.debug("transform",{codec:s}),o.setupTransform(n,t.readable,t.writable,i,s)})})();
//# sourceMappingURL=livekit-client.e2ee.worker-B8uLGUGk.js.map
